<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aether Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase and AlpineJS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/alpinejs" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Poppins', sans-serif; }
        body { font-family: 'Poppins', sans-serif; background-color: #f5f7fa; transition: background-color 0.3s, color 0.3s; }
        .dark body { background-color: #1a202c; color: #e2e8f0; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .chat-list-item:hover { background-color: #f3f4f6; }
        .dark .chat-list-item:hover { background-color: #2d3748; }
        .chat-list-item.active { background-color: #eef2ff; border-left: 4px solid #667eea; }
        .dark .chat-list-item.active { background-color: rgba(102, 126, 234, 0.1); border-left-color: #667eea; }
        [x-cloak] { display: none !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #4a5568; }
        .message-input { transition: box-shadow 0.3s; }
        .message-input:focus { box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3); }
        .online-status { width: 10px; height: 10px; border-radius: 50%; background-color: #10b981; }
        .offline-status { width: 10px; height: 10px; border-radius: 50%; background-color: #9ca3af; }
    </style>
</head>
<body x-data="app()" x-init="init()" :class="{ 'dark': isDarkMode }">
    
    <!-- Auth Overlay -->
    <div x-show="!currentUser" x-cloak class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 transition-opacity">
        <div class="w-full max-w-md bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-2xl">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-800 dark:text-white" x-text="authTab === 'login' ? 'Вход в систему' : 'Регистрация'"></h2>
                <template x-if="authTab === 'login'"><form @submit.prevent="handleLogin"><div class="mb-4"><label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Электронная почта</label><input type="email" x-model="credentials.email" required class="w-full px-4 py-2 rounded-lg border bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-800 dark:text-white"></div><div class="mb-6"><label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Пароль</label><input type="password" x-model="credentials.password" required class="w-full px-4 py-2 rounded-lg border bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-800 dark:text-white"></div><button type="submit" class="w-full gradient-bg text-white py-2 px-4 rounded-lg hover:opacity-90 transition-opacity">Войти</button><p class="text-center mt-4 text-sm text-gray-600 dark:text-gray-400">Нет аккаунта? <a href="#" @click.prevent="authTab = 'register'" class="text-indigo-600 dark:text-indigo-400 hover:underline">Зарегистрироваться</a></p></form></template>
                <template x-if="authTab === 'register'"><form @submit.prevent="handleRegister"><div class="mb-4"><label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Имя пользователя</label><input type="text" x-model="newUser.username" required class="w-full px-4 py-2 rounded-lg border bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-800 dark:text-white"></div><div class="mb-4"><label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Электронная почта</label><input type="email" x-model="newUser.email" required class="w-full px-4 py-2 rounded-lg border bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-800 dark:text-white"></div><div class="mb-6"><label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Пароль</label><input type="password" x-model="newUser.password" required class="w-full px-4 py-2 rounded-lg border bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-800 dark:text-white"></div><button type="submit" class="w-full gradient-bg text-white py-2 px-4 rounded-lg hover:opacity-90 transition-opacity">Зарегистрироваться</button><p class="text-center mt-4 text-sm text-gray-600 dark:text-gray-400">Уже есть аккаунт? <a href="#" @click.prevent="authTab = 'login'" class="text-indigo-600 dark:text-indigo-400 hover:underline">Войти</a></p></form></template>
            </div>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div class="flex h-screen" x-show="currentUser" x-cloak>
        <!-- Sidebar -->
        <div class="hidden md:flex md:w-64 flex-col gradient-bg text-white">
            <div class="p-6 flex items-center space-x-3">
                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center flex-shrink-0"><span class="text-indigo-600 font-bold text-xl" x-text="currentUser?.username.charAt(0).toUpperCase()"></span></div>
                <div><h1 class="font-bold text-xl" x-text="currentUser?.username"></h1><p class="text-xs opacity-75" x-text="currentUser?.privacy_show_online ? 'Online' : 'Не в сети'"></p></div>
            </div>
            <nav class="px-4 py-2 flex-1"><ul class="space-y-2"><li><a @click.prevent="toggleTheme" href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white hover:bg-opacity-10 transition"><i class="fas" :class="isDarkMode ? 'fa-sun' : 'fa-moon'"></i><span x-text="isDarkMode ? 'Светлая тема' : 'Тёмная тема'"></span></a></li><li><a @click.prevent="openSettings('profile')" href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white hover:bg-opacity-10 transition"><i class="fas fa-user"></i><span>Профиль</span></a></li><li><a @click.prevent="openSettings('privacy')" href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-white hover:bg-opacity-10 transition"><i class="fas fa-cog"></i><span>Настройки</span></a></li></ul></nav>
            <div class="p-4"><button @click="handleLogout" class="w-full flex items-center justify-center space-x-2 px-4 py-2 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition"><i class="fas fa-sign-out-alt"></i><span>Выйти</span></button></div>
        </div>
        
        <!-- Chat List -->
        <div class="w-full md:w-1/3 lg:w-1/4 flex-col border-r border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800" :class="{'hidden md:flex': currentChat, 'flex': !currentChat}">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700"><div class="relative"><input type="text" placeholder="Поиск пользователей..." x-model="searchQuery" @input.debounce.300ms="searchUsers" class="w-full pl-10 pr-4 py-2 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 message-input"><i class="fas fa-search absolute left-3 top-3 text-gray-400"></i></div></div>
            <div class="flex-1 overflow-y-auto custom-scrollbar">
                <template x-if="isLoadingChats"><div class="text-center p-4 text-gray-500 dark:text-gray-400">Загрузка...</div></template>
                <template x-if="!isLoadingChats"><template><template x-for="chat in chatList" :key="chat.id"><div @click="selectChat(chat)" class="flex items-center p-4 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 border-b border-gray-200 dark:border-gray-700 chat-list-item" :class="{'active': currentChat?.id === chat.id}"><div class="relative"><div class="w-12 h-12 rounded-full gradient-bg text-white flex items-center justify-center mr-4 flex-shrink-0"><span class="font-bold text-xl" x-text="chat.otherParticipant.username.charAt(0).toUpperCase()"></span></div><div x-show="chat.otherParticipant.privacy_show_online" class="online-status absolute bottom-0 right-3 border-2 border-white dark:border-gray-800"></div><div x-show="!chat.otherParticipant.privacy_show_online" class="offline-status absolute bottom-0 right-3 border-2 border-white dark:border-gray-800"></div></div><div class="flex-1 overflow-hidden"><h3 class="font-semibold text-gray-800 dark:text-gray-200 truncate" x-text="chat.otherParticipant.username"></h3><p class="text-sm text-gray-500 dark:text-gray-400 truncate" x-text="chat.last_message || 'Нажмите, чтобы начать чат'"></p></div><div x-show="chat.unread_count > 0" class="bg-indigo-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs ml-2"><span x-text="chat.unread_count"></span></div></div></template><template x-if="chatList.length === 0"><div class="text-center py-10 px-4"><i class="fas fa-comments text-gray-300 dark:text-gray-600 text-4xl mb-3"></i><p class="text-gray-500 dark:text-gray-400" x-text="searchQuery ? 'Пользователь не найден' : 'Найдите пользователей для общения'"></p></div></template></template></template>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="flex-1 flex-col bg-gray-50 dark:bg-gray-700" :class="{'flex': currentChat, 'hidden md:flex': !currentChat}">
            <template x-if="currentChat"><div class="flex flex-col h-full"><div class="flex items-center p-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800"><button @click="currentChat = null" class="md:hidden mr-4 text-gray-600 dark:text-gray-300"><i class="fas fa-arrow-left"></i></button><div class="relative"><div class="w-10 h-10 rounded-full gradient-bg text-white flex items-center justify-center mr-3 flex-shrink-0"><span class="font-bold text-lg" x-text="currentChat.otherParticipant.username.charAt(0).toUpperCase()"></span></div><div x-show="currentChat.otherParticipant.privacy_show_online" class="online-status absolute bottom-0 right-2 border-2 border-white dark:border-gray-800"></div><div x-show="!currentChat.otherParticipant.privacy_show_online" class="offline-status absolute bottom-0 right-2 border-2 border-white dark:border-gray-800"></div></div><div><h2 class="font-semibold text-gray-800 dark:text-gray-200" x-text="currentChat.otherParticipant.username"></h2><p class="text-xs text-gray-500 dark:text-gray-400" x-text="currentChat.otherParticipant.privacy_show_online ? 'в сети' : 'был(а) недавно'"></p></div></div><div class="flex-1 p-6 overflow-y-auto custom-scrollbar" x-ref="messages"><template x-for="message in messages" :key="message.id"><div class="flex mb-4" :class="{'justify-end': message.sender_id === currentUser.id, 'justify-start': message.sender_id !== currentUser.id}"><div class="max-w-md px-4 py-3 rounded-2xl" :class="{'gradient-bg text-white rounded-br-lg': message.sender_id === currentUser.id, 'bg-white dark:bg-gray-800 rounded-bl-lg shadow-md': message.sender_id !== currentUser.id}"><p x-text="message.content"></p><span class="text-xs opacity-75 mt-1 block text-right" x-text="new Date(message.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})"></span></div></div></template></div><div class="p-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700"><form @submit.prevent="sendMessage" class="flex items-center space-x-4"><input type="text" x-model="newMessage" placeholder="Введите сообщение..." class="w-full px-4 py-2 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 message-input"><button type="submit" class="w-12 h-12 rounded-full gradient-bg text-white flex items-center justify-center flex-shrink-0 hover:opacity-90 transition-opacity"><i class="fas fa-paper-plane"></i></button></form></div></div></template>
            <template x-if="!currentChat"><div class="flex-1 flex items-center justify-center text-center text-gray-500 dark:text-gray-400"><div><i class="fas fa-comments text-5xl mb-4 text-gray-300 dark:text-gray-600"></i><h2 class="text-xl">Выберите чат для начала общения</h2></div></div></template>
        </div>
    </div>
    
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('app', () => {
                const supabaseUrl = 'https://dvgdliaakfpaycwgqovx.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2Z2RsaWFha2ZwYXljd2dxb3Z4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3MjE3NjMsImV4cCI6MjA3MTI5Nzc2M30.h4eSXGaopkILndFMD_tF6jlxOlwsXCa_AdDC-G6L0b4';
                const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

                return {
                    currentUser: null, authTab: 'login', credentials: { email: '', password: '' }, newUser: { username: '', email: '', password: '' },
                    chatList: [], currentChat: null, messages: [], newMessage: '', searchQuery: '', isLoadingChats: true, realtimeSubscription: null,
                    isSettingsOpen: false, settingsTab: 'profile', profileData: { username: '', privacy_show_online: true },
                    isDarkMode: true,

                    init() { 
                        this.isDarkMode = localStorage.getItem('theme') !== 'light'; 
                        this.applyTheme(); 
                        supabase.auth.getSession().then(({ data: { session } }) => { 
                            if (session) this.loadAppData(session.user); else this.showAuthScreen('login'); 
                        }); 
                        supabase.auth.onAuthStateChange((_, session) => { 
                            if (session) this.loadAppData(session.user); else { this.currentUser = null; this.showAuthScreen('login'); } 
                        }); 
                    },
                    
                    async loadAppData(user) { 
                        const { data: profile, error } = await supabase.from('profiles').select('*').eq('id', user.id).single(); 
                        if (error) { console.error("Не удалось загрузить профиль:", error); supabase.auth.signOut(); return; }
                        this.currentUser = profile; 
                        await this.loadChats(); 
                        this.setupRealtime(); 
                        document.querySelector('[x-show="!currentUser"]').classList.add('hidden'); 
                    },
                    
                    showAuthScreen(type) { 
                        this.authTab = type; this.currentUser = null;
                        if (this.realtimeSubscription) this.realtimeSubscription.unsubscribe();
                        document.querySelector('[x-show="!currentUser"]').classList.remove('hidden'); 
                    },
                    
                    async handleLogin() { const { error } = await supabase.auth.signInWithPassword(this.credentials); if (error) alert(error.message); },
                    async handleRegister() { const { data, error } = await supabase.auth.signUp({ email: this.newUser.email, password: this.newUser.password, options: { data: { username: this.newUser.username } } }); if (error) alert(error.message); else if (data.user) { alert('Регистрация успешна! Проверьте почту.'); this.authTab = 'login'; } },
                    async handleLogout() { if (confirm('Вы уверены?')) { await supabase.auth.signOut(); location.reload(); } },
                    applyTheme() { document.documentElement.classList.toggle('dark', this.isDarkMode); },
                    toggleTheme() { this.isDarkMode = !this.isDarkMode; localStorage.setItem('theme', this.isDarkMode ? 'dark' : 'light'); this.applyTheme(); },
                    
                    async loadChats() {
                        this.isLoadingChats = true; if (!this.currentUser) return;
                        try {
                            const { data: chatIdsData, error: chatIdsError } = await supabase.from('user_chats').select('chat_id').eq('user_id', this.currentUser.id);
                            if (chatIdsError || !chatIdsData || chatIdsData.length === 0) { this.chatList = []; return; }
                            const chatIds = chatIdsData.map(c => c.chat_id);
                            const { data: chatsData, error: chatsError } = await supabase.from('chats').select(`id,created_at,updated_at,last_message,participants:user_chats(profile:profiles(id,username,privacy_show_online))`).in('id', chatIds).neq('participants.user_id', this.currentUser.id);
                            if (chatsError) { this.chatList = []; return; }
                            this.chatList = chatsData.map(chat => ({ id: chat.id, created_at: chat.created_at, updated_at: chat.updated_at, last_message: chat.last_message, otherParticipant: chat.participants[0]?.profile, unread_count: 0 })).filter(chat => chat.otherParticipant).sort((a, b) => new Date(b.updated_at || b.created_at) - new Date(a.updated_at || a.created_at));
                        } catch (error) { console.error('Ошибка в loadChats:', error); this.chatList = []; } 
                        finally { this.isLoadingChats = false; }
                    },

                    async searchUsers() {
                        if (this.searchQuery.trim().length < 2) { await this.loadChats(); return; }
                        const { data: users, error } = await supabase.from('profiles').select('*').ilike('username', `%${this.searchQuery}%`).neq('id', this.currentUser.id).limit(10);
                        if (error) { console.error('Ошибка поиска:', error); return; }
                        this.chatList = users.map(user => ({ id: `search-${user.id}`, isSearchResult: true, otherParticipant: user, last_message: 'Нажмите, чтобы начать чат' }));
                    },

                    // --- ИСПРАВЛЕННАЯ ФУНКЦИЯ ---
                    async selectChat(chat) {
                        try {
                            let targetChat = chat;
                            
                            if (chat.isSearchResult) {
                                const participant = chat.otherParticipant;

                                // 1. Ищем чат с помощью вашей рабочей функции get_common_chat_id
                                const { data: commonChatId, error: findError } = await supabase.rpc('get_common_chat_id', {
                                    p_user_id: participant.id
                                });

                                if (findError) {
                                    alert('Ошибка при поиске существующего чата: ' + findError.message);
                                    return;
                                }

                                let chatIdToSelect = commonChatId;

                                // 2. Если чат не найден, создаем его с помощью вашей рабочей функции create_chat_with_user
                                if (!chatIdToSelect) {
                                    const { data: newChatId, error: createError } = await supabase.rpc('create_chat_with_user', {
                                        other_user_id: participant.id
                                    });
                                    
                                    if (createError) {
                                        alert('Не удалось создать чат: ' + createError.message);
                                        await this.loadChats();
                                        return;
                                    }
                                    chatIdToSelect = newChatId;
                                }

                                // 3. Обновляем список чатов и находим тот, с которым будем работать
                                await this.loadChats();
                                const foundChat = this.chatList.find(c => c.id === chatIdToSelect);
                                
                                targetChat = foundChat || { id: chatIdToSelect, otherParticipant: participant };
                            }
                            
                            this.currentChat = targetChat;
                            this.searchQuery = '';
                            await this.loadMessages();
                            
                        } catch (error) {
                            console.error('Критическая ошибка в selectChat:', error);
                            alert('Произошла непредвиденная ошибка при открытии чата.');
                        }
                    },

                    async loadMessages() { 
                        if (!this.currentChat) return; this.messages = [];
                        const { data, error } = await supabase.from('messages').select('*').eq('chat_id', this.currentChat.id).order('created_at', { ascending: true });
                        if (error) { console.error('Ошибка загрузки сообщений:', error); return; }
                        this.messages = data || []; this.scrollToBottom();
                    },
                    
                    async sendMessage() { 
                        if (!this.newMessage.trim() || !this.currentChat) return; 
                        const content = this.newMessage; this.newMessage = ''; 
                        const { error } = await supabase.from('messages').insert({ chat_id: this.currentChat.id, sender_id: this.currentUser.id, content });
                        if (error) { console.error('Ошибка отправки:', error); this.newMessage = content; return; }
                        supabase.from('chats').update({ last_message: content, updated_at: new Date().toISOString() }).eq('id', this.currentChat.id).then();
                    },
                    
                    setupRealtime() {
                        if (this.realtimeSubscription) this.realtimeSubscription.unsubscribe();
                        this.realtimeSubscription = supabase.channel('public:messages_and_chats')
                            .on('postgres_changes', { event: '*', schema: 'public' }, (payload) => { this.loadChats(); if (payload.table === 'messages' && payload.eventType === 'INSERT' && payload.new.chat_id === this.currentChat?.id) { this.messages.push(payload.new); this.scrollToBottom(); } })
                            .subscribe();
                    },
                    
                    scrollToBottom() { this.$nextTick(() => { const el = this.$refs.messages; if(el) el.scrollTop = el.scrollHeight; }); },
                    openSettings(tab) { this.settingsTab = tab; this.profileData.username = this.currentUser.username; this.profileData.privacy_show_online = this.currentUser.privacy_show_online; this.isSettingsOpen = true; },
                    async handleProfileUpdate() { /* ... */ },
                };
            });
        });
    </script>
</body>
</html>
